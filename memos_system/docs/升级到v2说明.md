# MemOS v2.0 升级说明

## 新版本特性

### 1. Qdrant 向量数据库
- 替代 JSON 文件存储，性能大幅提升
- 支持高效的向量相似度搜索
- 自动索引，快速过滤
- 本地持久化，无需额外服务

### 2. Neo4j 知识图谱（可选）
- 存储实体和关系
- 支持多跳查询
- 路径发现
- 需要额外安装 Neo4j

### 3. 混合检索
- 向量 + BM25 关键词搜索
- 重要度加权排序
- 图增强搜索（启用 Neo4j 时）

### 4. 高级功能
- 多用户支持
- MemCube 记忆容器
- 偏好/工具记忆
- 文档导入

## 升级步骤

### 1. 安装依赖
```bash
cd k:\neruo\my-neuro-main
pip install qdrant-client neo4j rank-bm25 pypdf beautifulsoup4
```

### 2. 启动新版服务
双击 `启动记忆系统v2.bat`

或手动运行：
```bash
cd memos_system
python api/memos_api_server_v2.py
```

### 3. 数据自动迁移
首次启动时，如果检测到旧的 JSON 数据，会自动迁移到 Qdrant。

## 配置说明

配置文件：`memos_system/config/memos_config.json`

```json
{
  "storage": {
    "vector": {
      "type": "qdrant",
      "path": "./data/qdrant",       // Qdrant 数据目录
      "collection_name": "memories"
    },
    "graph": {
      "enabled": false,              // 设为 true 启用 Neo4j
      "uri": "bolt://localhost:7687",
      "user": "neo4j",
      "password": "your_password"
    }
  },
  "search": {
    "default_top_k": 5,
    "similarity_threshold": 0.5,
    "importance_weight": 0.3,        // 重要度权重
    "enable_bm25": false,            // 启用 BM25 混合搜索
    "enable_graph_query": false      // 启用图增强搜索
  }
}
```

## 启用 Neo4j（可选）

### 方式一：Docker（推荐）
```bash
docker run -d \
  -p 7474:7474 -p 7687:7687 \
  -e NEO4J_AUTH=neo4j/your_password \
  --name neo4j \
  neo4j:latest
```

### 方式二：本地安装
1. 下载 https://neo4j.com/download/
2. 安装并启动
3. 访问 http://localhost:7474 设置密码

### 启用配置
```json
{
  "storage": {
    "graph": {
      "enabled": true,
      "uri": "bolt://localhost:7687",
      "user": "neo4j",
      "password": "your_password"
    }
  }
}
```

## API 端点

### 兼容旧版
| 端点 | 说明 |
|------|------|
| `POST /add` | 添加记忆（LLM 加工） |
| `POST /add_raw` | 直接添加记忆 |
| `POST /search` | 搜索记忆 |
| `GET /list` | 列出记忆 |
| `DELETE /delete/{id}` | 删除记忆 |
| `GET /stats` | 统计信息 |
| `POST /deduplicate` | 去重 |

### 新增端点
| 端点 | 说明 |
|------|------|
| `GET /graph/stats` | 图谱统计 |
| `GET /graph/entities` | 列出实体 |
| `POST /graph/query/related` | 查找相关实体 |

## 向后兼容

v2.0 完全兼容 v1.0 的 API 接口，无需修改前端代码。

## 回退到旧版

如果遇到问题，可以回退到旧版：
```bash
python api/memos_api_server.py  # 使用旧版
```

## 常见问题

### Q: Qdrant 初始化失败
A: 确保安装了 qdrant-client：`pip install qdrant-client`

### Q: Neo4j 连接失败
A: 1. 检查 Neo4j 是否启动
   2. 检查密码是否正确
   3. 可以先禁用 Neo4j 使用

### Q: 数据迁移失败
A: 手动运行迁移脚本：
```bash
cd memos_system/scripts
python migrate_to_qdrant.py
```

## 性能对比

| 指标 | v1.0 (JSON) | v2.0 (Qdrant) |
|------|-------------|---------------|
| 搜索速度 | O(n) | O(log n) |
| 10000条搜索 | ~500ms | ~10ms |
| 存储效率 | 低 | 高 |
| 并发支持 | 差 | 好 |
